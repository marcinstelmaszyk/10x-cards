// This file will be used as the actual entry point for Cloudflare Workers
// to inject polyfills before loading the Astro-generated worker

// Add required polyfills missing in Cloudflare Workers
if (typeof MessageChannel === "undefined") {
  // Define MessagePort first
  class MessagePortPolyfill {
    // These methods are required by React SSR internals, even if empty.
    postMessage() {
      /* No-op */
    }
    addEventListener() {
      /* No-op */
    }
    removeEventListener() {
      /* No-op */
    }
    dispatchEvent() {
      return true;
    }
  }

  // Define MessageChannel using the MessagePort polyfill
  class MessageChannelPolyfill {
    // This class only needs a constructor for the polyfill to work.
    constructor() {
      this.port1 = new MessagePortPolyfill();
      this.port2 = new MessagePortPolyfill();
    }
  }

  // Assign the polyfills to globalThis
  globalThis.MessageChannel = MessageChannelPolyfill;
  globalThis.MessagePort = MessagePortPolyfill;
}

// Import the actual worker code generated by Astro
// IMPORTANT: Ensure this path is correct relative to the worker entry point
import workerScript from "./dist/_worker.js";

// Export the worker handlers
export default workerScript.default;
export const routeMap = workerScript.routeMap;
